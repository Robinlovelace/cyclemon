---
# output: github_document
output:
  # bookdown::github_document2:
  bookdown::word_document2:
    number_sections: true
# title: "Modelling cycling potential to inform interventions in rural areas: insights from a case study of Monmouthshire, Wales"
# title: "Modelling active travel in rural areas: a combined origin-destination and spatial network approach to estimate walking and cycling potential and prioritise interventions"
title: Combining origin-destination and spatial network approaches to estimate walking and cycling potential
bibliography: cyclemon.bib
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
library(tidyverse)
library(sf)
library(tmap)
if(!file.exists("cyclemon.bib")) {
  download.file("https://github.com/Robinlovelace/cyclemon/releases/download/0.0.1/cyclemon.bib", "cyclemon.bib")
}
```

```{r, eval=FALSE}
# set-up
browseURL("~/projects/cyclemon/draft-active-travel-guidance.pdf") # welsh active travel guidance
readLines("~/projects/cyclemon/bid-spec.html")[1:30]
system("pandoc ~/projects/cyclemon/bid-spec.html -o bid-spec.md")
browseURL("README.pdf")
# citations
citr::tidy_bib_file(rmd_file = "README.Rmd", messy_bibliography = "~/uaf/allrefs.bib", file = "cyclemon.bib")
piggyback::pb_upload("cyclemon.bib")
piggyback::pb_download_url("cyclemon.bib")
```

<!-- badges: start -->

<!-- badges: end -->

<!-- This repo contains reproducible code to support the analysis of cycling potential in Monmouthshire, Wales. -->

# Introduction

There has been much research on mode shift since the origins of applied transport planning and modelling in the 1950s [@boyce_forecasting_2015; @aguilera_passenger_2014]. Within this broad field of research, uptake of 'active modes' (walking and cycling) has become a recent focus [@gotschi_comprehensive_2017]. A range of methods have been used to understand and model walking and cycling levels, with 'getting people cycling' being the topic of numerous papers during the 2010 [e.g. @beecham_visual_2012; @grise_if_2018; @larsen_build_2013; @raffler_cycling_2019; @zhang_prioritizing_2014].

Within the wide range of approaches used to model cycling uptake, two broad approaches have been particularly prominent in the literature. The *origin-destination approach* relies on estimates of current travel behaviour, represented in origin-destination datasets reporting the number of trips, e.g. by mode of travel to work on a typical working day between residential zone origins and workplace destinations. This approach was used in the Propensity to Cycle Tool (PCT), which was originally developed to support strategic cycle network planning based on commuter data for England [@lovelace_propensity_2017]. The 'PCT approach', which is a particular implementation of the 'origin-destination' approach that models cycling uptake in terms of 'distance-hilliness decay' functions (which can include other explanatory variables such as traffic levels) has subsequently been adapted to explore cycling potential in other contexts, including cycling uptake in US cities with low cycling levels [@ahmad_comparison_2020] and the potential for mode shift to cycling for the 'school commute' in across all state schools in England, with publicly available visualisations down to the street level [@goodman_scenarios_2019].

The aim of this paper is to demonstrate the relative merits of the 'origin-destination approach' implemented in the PCT and the 'spatial network' approach implemented in the open source sDNA software [@chan_using_2019].
We do so using reproducible methods and open access input data to encourage others to employ the techniques in other areas to support evidence-based interventions to enable cycling uptake and as a basis for future research and development.

# Study area and input data

The case study area is the local authority district of Monmouthshire, in rural South Wales (Figure \@ref(fig:case)). The research took place in the context of the Welsh Active Travel Act [@welshgovernment_active_2020].

```{r, eval=FALSE}
remotes::install_github("robinlovelace/ukboundaries")
```

```{r case, fig.cap="Case study area, with the parishes of Chepstow and Abergavenny highlighted in red."}
knitr::include_graphics("README_files/figure-gfm/unnamed-chunk-4-1.png")
```

To define the 'area of interest', two approaches were implemented: a simple buffer and a we used a 2 stage buffering process, as illustrated in Figure \@ref(fig:buffers).
Reasons for exploring options to go beyond the simple buffering approach were computational and policy-related: computationally, model run times (and visualisation load times in interactive maps) depend on the amount of data served, so there is an incentive to reduce the size of the input data; from a policy perspective, planners usually want to focus on a particular region over which they have control (and budget).
The simple buffer approach was simply to create a buffer of a fixed distance (10 km in the first instance) around the destination (in this case the parishes of Chepstown and Abergavenny).
Building on this, the three-stage process was as follows:

1. Create a buffer around the zone of interest with a threshold distance (set to 10 km)
2. Create a separate buffer around the region of interest to allow for some (more limited) inter-regional flow (set to 1 km)
3. Calculate the intersection between the two buffers outlined in the previous stages

The advantages of the simple buffer approach included simplicity and minimisation of parameters that had to be hard-coded into the analysis. 
Taking both factors into account, we use the simple approach represented in the left hand plot of Figure \@ref(fig:buffers), saving the three stage approach for contexts where it is advantageous to model cross-region flow but also to reduce the proportion of trips modelled crossing regional/state boundaries.

<!-- This process is now available as a function, ... in the package stplanr. -->

```{r buffers, eval=TRUE, fig.cap="Illustration of the simple buffer and three stage buffering approaches to identify areas of interest within which travel to destinations in the zones could take place", out.width="49%", fig.show='hold'}
uklads = ukboundaries::lad2018
# View(uklads %>% st_drop_geometry())
monmouthshire = uklads %>% filter(lau118nm == "Monmouthshire")
# mapview::mapview(monmouthshire)
# uk_codes = read_csv("~/hd/data/uk/codes/RGC_JUNE_2020_UK_v2.csv")
# View(uk_codes)
chepstow = sf::read_sf("input-data/chepstow.geojson")
# aim: generate buffers (update stplanr)
# chepstow_buffer = stplanr::geo_buffer(chepstow, dist = 10000) # fails
buffer_dist = 10000
region_buffer_dist = 5000 
zone_buffer = chepstow %>% 
  sf::st_transform(27700) %>% 
  sf::st_buffer(buffer_dist) %>% 
  sf::st_transform(4326)
region_buffer = monmouthshire %>% 
  sf::st_transform(27700) %>% 
  sf::st_buffer(region_buffer_dist) %>% 
  sf::st_transform(4326)
zone_buffer_in_region = sf::st_intersection(zone_buffer, region_buffer)

tm_shape(zone_buffer, bbox = tmaptools::bb(zone_buffer, 1.5)) +
  tm_polygons(col = "green", alpha = 0.4) +
  tm_shape(monmouthshire) +
  tm_polygons(lwd = 5) + 
  tm_shape(region_buffer) +
  tm_borders(lwd = 5, lty = 2) +
  tm_shape(zone_buffer) +
  tm_polygons(col = "green", alpha = 0.4) +
  tm_shape(monmouthshire) +
  tm_borders(lwd = 5) +
  tm_shape(chepstow) +
  tm_polygons(col = "red") +
  tm_scale_bar(position = "left")

tm_shape(zone_buffer_in_region, bbox = tmaptools::bb(zone_buffer_in_region, 1.5)) +
  tm_polygons(col = "green", alpha = 0.4) +
  tm_shape(monmouthshire) +
  tm_polygons(lwd = 5) + 
  tm_shape(region_buffer) +
  tm_borders(lwd = 5, lty = 2) +
  tm_shape(zone_buffer_in_region) +
  tm_polygons(col = "green", alpha = 0.4) +
  tm_shape(monmouthshire) +
  tm_borders(lwd = 5) +
  tm_shape(chepstow) +
  tm_polygons(col = "red") +
  tm_scale_bar(position = "left")

# mapview::mapview(chepstow_buffer_in_region)
# plot(chepstow)
# abber = readRDS("input-data/abergavenny.geojson")
```



<!-- # Study area and data -->

```{r, eval=FALSE, echo=FALSE}
desire_lines_abergavenny = readRDS("input-data/school_data_desire_lines_chepstow.Rds")
mapview::mapview(desire_lines_abergavenny)
sf::write_sf(desire_lines_abergavenny, "desire_lines_abergavenny.geojson")
piggyback::pb_upload("desire_lines_abergavenny.geojson")
```

## Definition of travel watersheds

Explain how extent of analysis was computed (RL + CC)

# Origin-destination analysis

Describe a generalised version of the 'PCT approach' with recent modifications, improvements and areas for improvement (RL)


## Origin-destination data processing 

Talk about data availability, possibility of modelling OD data with SIMs and od package (RL)

## Routing: OD data

Different routing options (RL)

## Estimating cycling uptake

Go Dutch and other options (RL)

# Spatial network analysis

Explanation of the method and reproducible example (CC)

## Spatial network processing

## Network modelling

## Scenario analysis

How the walking/cycling scenarios were implemented with sDNA (CC)

# Integrated OD and SNA network analysis

RL + CC

## Road network visualisation

```{r, eval=FALSE}
school_data_route_segments = readRDS("input-data/school_data_route_segments_balanced_chepstow.Rds")


system.time({
  rnet = stplanr::overline(sf::st_cast(school_data_route_segments, "LINESTRING"), "n")
})
br = c(0, 1, 2, 4, 8, 16, 32, 64)
plot(rnet, breaks = br)
plot(school_data_route_network["n"], breaks = br)
nrow(rnet)
nrow(school_data_route_network)
summary(rnet$n)
summary(school_data_route_network$n)

b_pct = c(0, 1, 2, 5, 10, 20, 50, 100, 500)

library(tmap)
tmap_mode("view")

tm_shape(rnet) +
  tm_lines(col = "n", breaks = b_pct,
           # lwd = "n",
           scale = 4,
           palette = "Blues") +
  tm_scale_bar()

saveRDS(school_data_route_segments, "input-data/school_data_route_segments_balanced_chepstow.Rds")

```

# Findings

RL + CC

# Conclusions

RL + CC

# References
